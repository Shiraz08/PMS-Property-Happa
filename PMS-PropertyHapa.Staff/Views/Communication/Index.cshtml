@using PMS_PropertyHapa.Staff.Services
@using PMS_PropertyHapa.Staff.Services.IServices
@using System.Security.Claims
@using static PMS_PropertyHapa.Shared.Enum.SD
@model PMS_PropertyHapa.Models.DTO.CommunicationsViewModel
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@inject IPermissionService _permissionService;
@{
    var userId = Context.Request.Cookies["userId"];
    bool addCommunicationPermission = await _permissionService.HasAccess(userId, (int)UserPermissions.AddCommunication);
}

<style>
    .no-print {
        display: none;
    }
</style>

<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-sm-6">
                    <h3>Communication</h3>
                </div>
                <div class="col-12 col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/Home/Index"><i data-feather="home"></i></a></li>
                        <li class="breadcrumb-item">Communication</li>
                        <li class="breadcrumb-item active">List</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="container-fluid my-4">
            <div class="row">
                <div class="col-12 col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                         
                            <div class="d-flex justify-content-start mb-3">
                                <button id="copyButton" class="btn btn-success mr-1">Copy</button>
                                <button id="csvButton" class="btn btn-success mr-1">CSV</button>
                                <button id="excelButton" class="btn btn-success mr-1">Excel</button>
                                <button id="pdfButton" class="btn btn-success mr-1">PDF</button>
                                <button id="printButton" class="btn btn-success mr-1">Print</button>
                            </div>
                            @if (addCommunicationPermission)
                            {
                                <div class="right-side-header">
                                    <a class="btn btn-success d-flex border-0 align-items-center" href="@Url.Action("AddCommunication", "Communication")">
                                        Add New Communication
                                    </a>
                                </div>
                            }
                            
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="communicationTable">
                                    <thead>
                                        <tr>
                                            <th class="text-center" style="width: 25%">Subject</th>
                                            <th class="text-center" style="width: 25%">Association List</th>
                                            <th class="text-center" style="width: 10%">Sent At</th>
                                            <th class="text-center" style="width: 10%">Expiry Date</th>
                                            <th class="text-center" style="width: 15%">Delivery Method</th>
                                            <th class="text-center" style="width: 15%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var communication in Model?.Communications)
                                        {
                                            <tr>
                                                <td><i class="fa fa-envelope"></i> @communication?.Subject</td>
                                               @{
    // Splitting the comma-separated IDs and counting them
    var tenantIds = communication?.TenantIds?.Split(',', StringSplitOptions.RemoveEmptyEntries);
    var propertyIds = communication?.PropertyIds?.Split(',', StringSplitOptions.RemoveEmptyEntries);

    // Checking if there are any tenant IDs or property IDs
    bool hasSomeTenants = tenantIds?.Length > 0;
    bool hasSomeProperties = propertyIds?.Length > 0;
}
                                              
@if (hasSomeTenants && hasSomeProperties)
{
    <td>Some Tenants, Some Properties</td>
}
else if (hasSomeTenants)
{
    <td>Some Tenants, All Properties</td>
}
else if (hasSomeProperties)
{
    <td>All Tenants, Some Properties</td>
}
else
{
    <td>All Tenants, All Properties</td>
}
                                                <td>@communication?.AddedAt.ToString("yyyy-MM-dd")</td>
                                                <td>@communication?.RemoveFeedDate?.ToString("yyyy-MM-dd")</td>
                                                <td>
                                                    @if ((bool)communication?.IsByEmail)
                                                    {
                                                        <i class="fa fa-envelope fa-2x text-primary mb-2" title="Email"></i>
                                                    }
                                                    @if ((bool)communication?.IsByText)
                                                    {
                                                        <i class="fa fa-phone fa-2x text-success mb-2" title="Text Message"></i>
                                                    }
                                                    @if ((bool)communication?.IsShowCommunicationInTenantPortal)
                                                    {
                                                        <i class="fa fa-globe fa-2x text-info mb-2" title="Tenant Portal"></i>
                                                    }
                                                </td>
                                                <td style="justify-content:center">
                                                    @if (addCommunicationPermission)
                                                    {
                                                        <button onclick="editCommunication(@communication.Communication_Id)" class="btn btn-success btn-sm" style="padding: 3px 8px; margin-right: 5px; display: inline-block;">Edit</button>
                                                        <button onclick="deleteCommunication(@communication.Communication_Id)" class="btn btn-danger btn-sm" style="padding: 3px 8px; display: inline-block;">Delete</button>
                                                    }
                                                    </td>
                                            </tr>
                                        }

                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>


<script>
    $(document).ready(function () {
        var table = $('#communicationTable').DataTable({
            paging: true,
            ordering: true,
            info: true,
            searching: true
        });
    });

    function exportToCSV() {
        var csv = [];
        var rows = document.querySelectorAll("table tr");
        for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll("td, th");
            for (var j = 0; j < cols.length; j++)
                row.push(cols[j].innerText);
            csv.push(row.join(","));
        }
        downloadCSV(csv.join("\n"), 'export.csv');
    }

    function downloadCSV(csv, filename) {
        var csvFile;
        var downloadLink;
        csvFile = new Blob([csv], { type: "text/csv" });
        downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
    }

   

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.autoTable({ html: '#communicationTable' });
        doc.save('export.pdf');
    }

    $('#copyButton').on('click', function () {
        var text = $("#communicationTable").clone().find('th, td').each(function () {
            $(this).text($(this).text());
        }).end().prop('outerHTML');

        var $temp = $("<textarea>");
        $("body").append($temp);
        $temp.val(text).select();
        document.execCommand("copy");
        $temp.remove();

        Swal.fire({
            icon: 'success',
            title: 'Copied to Clipboard',
            showConfirmButton: false,
            timer: 1500
        });
    });


    function printTable() {
        window.print();
    }


    $('#csvButton').on('click', function () {
        exportToCSV();
    });

    $('#excelButton').on('click', function () {
        var wb = XLSX.utils.table_to_book(document.getElementById('communicationTable'), { sheet: "Sheet1" });
        XLSX.writeFile(wb, "CommunicationData.xlsx");
    });

    $('#pdfButton').on('click', function () {
        exportToPDF();
    });

    $('#printButton').on('click', function () {
        printTable();
    });

    function deleteCommunication(communicationId) {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You will not be able to recover this communication!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '@Url.Action("DeleteCommunication", "Communication")',
                    type: 'POST',
                    data: { Communication_Id: communicationId },
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Communication deleted successfully',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            window.location.reload();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Something went wrong!'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!'
                        });
                    }
                });
            }
        });
    }


    function editCommunication(communicationId) {
        var url = '@Url.Action("EditCommunication", "Communication")' + '?communicationId=' + communicationId;
        window.location.href = url; 
    }
</script>
