@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="page-body py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-3">
                <label class="form-label" for="unitsFinal">Number of Units</label>
                <input class="form-control" id="unitsFinal" value="1" type="number" name="unitsFinal" placeholder="Number of Units">
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12 d-flex justify-content-center">
                <div class="switch-container">
                    <span class="switch-label">Monthly</span>
                    <label class="switch">
                        <input type="checkbox" id="planSelection"><span class="switch-state"></span>
                    </label>
                    <span class="switch-label">Yearly</span>
                </div>
            </div>
        </div>
        <div class="row justify-content-center" id="monthly-container">
            <!-- Monthly Subscription blocks will be dynamically inserted here -->
        </div>
        <div class="row justify-content-center d-none" id="yearly-container">
            <!-- Yearly Subscription blocks will be dynamically inserted here -->
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    $(document).ready(function () {
        $('#planSelection').change(function () {
            if ($(this).prop('checked')) {
                $('#monthly-container').addClass('d-none');
                $('#yearly-container').removeClass('d-none');
            } else {
                $('#monthly-container').removeClass('d-none');
                $('#yearly-container').addClass('d-none');
            }
        });
        loadSubscriptions();
    });

    function loadSubscriptions() {
        $.ajax({
            url: '/Subscriptions/GetAllSubscriptions',
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.success && Array.isArray(response.data)) {
                    const monthlyContainer = $('#monthly-container');
                    const yearlyContainer = $('#yearly-container');

                    response.data.forEach(sub => {
                        const subscriptionBlock = createSubscriptionBlock(sub);
                        if (sub.SubscriptionType === 'Monthly') {
                            monthlyContainer.append(subscriptionBlock);
                        } else if (sub.SubscriptionType === 'Yearly') {
                            yearlyContainer.append(subscriptionBlock);
                        }
                    });
                } else {
                    console.error('Failed to load subscriptions:', response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('An error occurred while fetching subscriptions:', error);
            }
        });
    }

    function createSubscriptionBlock(subscription) {
        return `
                            <div class="col-auto">
                                <div class="pricing-block card text-center">
                                    <div class="pricing-header">
                                        <h2>${subscription.SubscriptionName}</h2>
                                        <div class="price-box">
                                            <div>
                                                    <h4 class="text-white" data-base-price="${subscription.Price.toFixed(2)}">$${subscription.Price.toFixed(2)} ${subscription.Currency}</h4>
                                                <p>/ ${subscription.SubscriptionType}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="pricing-list">
                                        <ul class="pricing-inner">
                                            <li>
                                                    <h6><span class="unitsBlock">${subscription.NoOfUnits}</span> Units</h6>
                                            </li>
                                            <li>
                                                <h6>${subscription.SmallDescription}</h6>
                                            </li>
                                            <li>
                                                <h6>${subscription.Tax}%
                                                    <span> Tax</span></h6>
                                            </li>
                                        </ul>
                                        <button class="btn btn-primary btn-lg" onclick="handleSubscriptionClick(${subscription.Price}, '${subscription.Id}', '${subscription.SubscriptionName}')" type="button">Subscribe</button>
                                    </div>
                                </div>
            </div>`;
    }

    function handleSubscriptionClick(price, id, name) {
        var formData = {
            Id : id,
            Title :name,
            Description: name,
            Price : price,
        };
        console.log("formData")
        $.ajax({
            url: '@Url.Action("SavePayment", "Subscriptions")',
            type: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function (res) {
                console.log(res.PubKey);
                console.log(res.SessionId);
                // Initialize Stripe with the publishable key
                var stripe = Stripe(res.PubKey);

                // Redirect to Stripe Checkout
                stripe.redirectToCheckout({ sessionId: res.SessionId })
                    .then(function (result) {
                        if (result.error) {
                            // Display error.message in your UI
                            alert(result.error.message);
                        }
                    });
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('Failed to save subscription');
            }
        });
    }

</script>