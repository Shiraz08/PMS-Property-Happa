@using PMS_PropertyHapa.Staff.Services
@using PMS_PropertyHapa.Staff.Services.IServices
@using System.Security.Claims
@using static PMS_PropertyHapa.Shared.Enum.SD
@model IEnumerable<PMS_PropertyHapa.Models.DTO.TenantModelDto>
@{
    ViewData["Title"] = "Tenants";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@inject IPermissionService _permissionService;
@{
    var userId = Context.Request.Cookies["userId"];
    bool addTenantPermission = await _permissionService.HasAccess(userId, (int)UserPermissions.AddTenant);
}
<style>
    .card {
         margin-bottom: 0px!important;
        }

    .list-persons .profile-mail {
        padding:0px !important;
    }
</style>
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-sm-6">
                    <h3>Tenant</h3>
                </div>
                <div class="col-12 col-sm-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/Home/Index"><i data-feather="home"></i></a></li>
                        <li class="breadcrumb-item">Tenant</li>
                        <li class="breadcrumb-item active">Index</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="email-wrap bookmark-wrap">
            <div class="row">
                <div class="col-xl-12 col-md-12 box-col-12 ">
                    <div class="email-right-aside bookmark-tabcontent contacts-tabs">
                        <div class="card email-body radius-left">
                            <div class="ps-0">
                                <div class="tab-content">
                                    <div class="tab-pane fade active show" id="pills-personal" role="tabpanel" aria-labelledby="pills-personal-tab">
                                        <div class="card mb-0">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <div class="left-side-header">
                                                        <div class="input-group">
                                                            <span class="input-group-text" id="basic-addon1">
                                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <g>
                                                                        <g>
                                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.2753 2.71436C16.0029 2.71436 19.8363 6.54674 19.8363 11.2753C19.8363 16.0039 16.0029 19.8363 11.2753 19.8363C6.54674 19.8363 2.71436 16.0039 2.71436 11.2753C2.71436 6.54674 6.54674 2.71436 11.2753 2.71436Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M19.8987 18.4878C20.6778 18.4878 21.3092 19.1202 21.3092 19.8983C21.3092 20.6783 20.6778 21.3097 19.8987 21.3097C19.1197 21.3097 18.4873 20.6783 18.4873 19.8983C18.4873 19.1202 19.1197 18.4878 19.8987 18.4878Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                        </g>
                                                                    </g>
                                                                </svg>
                                                            </span>
                                                            <input class="form-control" type="text" id="searchInput" placeholder="Search Tenant" aria-label="search" aria-describedby="basic-addon1">
                                                        </div>
                                                    </div>
                                                    @if (addTenantPermission)
                                                    {
                                                        <div class="right-side-header">
                                                            <a class="btn btn-success" href="@Url.Action("AddTenant","Tenant")">Add New Tenant</a>
                                                        </div>
                                                    }
                                                    
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="row list-persons" id="addcon">
                                                    <div class="col-xl-3 xl-20 col-md-5 box-col-6" style="padding-right: 0px;">
                                                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                                            @foreach (var item in Model?.OrderByDescending(x => x.TenantId) ?? Enumerable.Empty<PMS_PropertyHapa.Models.DTO.TenantModelDto>())
                                                            {
                                                                <a class="contact-tab-@item.TenantId nav-link" id="v-pills-@item.TenantId-tab" data-bs-toggle="pill" onclick="activeDivForTenant(@item.TenantId)" href="#v-pills-@item.TenantId" role="tab" aria-controls="v-pills-@item.TenantId" aria-selected="true">
                                                                    <div class="media">
                                                                        @if(item.Picture != null)
                                                                        {
                                                                            <img class="img-50 img-fluid m-r-20 rounded-circle update_img_0" src="@item.Picture" alt="Sample Image">
                                                                        }
                                                                        else
                                                                        {
                                                                            <img class="img-50 img-fluid m-r-20 rounded-circle update_img_0" src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="Sample Image">
                                                                        }
                                                                        <div class="media-body">
                                                                            <h6> <span class="first_name_0">@item.FirstName </span><span class="last_name_0">@item.LastName</span></h6>
                                                                            <p class="email_add_0">@item.EmailAddress</p>
                                                                        </div>
                                                                    </div>
                                                                </a>
                                                            }
                                                        </div>
                                                    </div>
                                                     <div class="col-xl-9 xl-20 col-md-7 box-col-6" style="padding-left: 0px;">
                                                        <div class="tab-content" id="v-pills-tabContent">
                                                            <div id="loader" style="display:none;"></div>
                                                            <div id="tenantDetailDiv"></div>
                                                        </div>
                                                    </div> 
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>

<script>
    $(document).ready(function () {
        $('#searchInput').on('input', function () {
            var searchText = $(this).val().toLowerCase();
            $('.nav-link').each(function () {
                var ownerName = $(this).find('.first_name_0').text().toLowerCase() + ' ' + $(this).find('.last_name_0').text().toLowerCase();
                if (ownerName.includes(searchText)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        var firstTenant = @Html.Raw(Json.Serialize(@Model?.OrderByDescending(x => x.TenantId)?.Take(1)?.Select(x => x.TenantId)?.FirstOrDefault()));
        if (firstTenant) {
            activeDivForTenant(@Model?.OrderByDescending(x => x.TenantId).Take(1).Select(x => x.TenantId).FirstOrDefault());

        }
    });

    function sumAmounts(items) {
        let total = items.reduce((sum, item) => sum + parseFloat(item.Amount), 0);
        return `<span>${total}</span>`;
    }

    function activeDivForTenant(index) {
        console.log("dfhsd");
        console.log(index);
        $('#tenantDetailDiv').empty()
        //start loading loader here
        showLoader();
        $.ajax({
            url: '@Url.Action("GetTenantDataById", "Tenant")',
            type: 'GET',
            data: { id: index },
            success: function (tenant) {
                console.log(tenant);
                // Format AddedDate to display only date
                var addedDate = new Date(tenant.AddedDate);
                var formattedAddedDate = addedDate.toLocaleDateString('en-US');


                var tenantssHtml = `
                            <div class="tab-pane contact-tab tab-content-child fade show active" id="v-pills" role="tabpanel" aria-labelledby="v-pills-tab">
                                <div class="profile-mail">
                                    <div class="d-flex justify-content-between border-0 p-2" style="align-items: flex-start !important; background-color: #f4f8ff;">
                                        <div class="media align-items-center">
                                        <a href="/Tenant/TenantDetails/${tenant.TenantId}" class="text-decoration-none text-dark">
                                            <img class="img-100 img-fluid m-r-20 rounded-circle update_img_0" src="${tenant.Picture != null ? tenant.Picture : 'https://bootdey.com/img/Content/avatar/avatar1.png'}" alt="Sample Image">
                                          </a> 
                                            <div class="media-body mt-0">
                                                <h3 class="font-primary" id="tenantName">${tenant.FirstName} ${tenant.LastName}</h3>
                                                <div class="d-flex justify-content-between gap-5 border-0 flex-wrap">
                                                    <div class="d-flex gap-3 border-0">
                                                        <div class="d-flex flex-column border-0 ">
                                                            <span id="tenantPhoneNumber">
                                                                <i class="fa fa-phone" aria-hidden="true" style="margin-right: 5px;"></i>${tenant.PhoneNumber}
                                                            </span>
                                                            <span class="font-primary" id="tenantEmail">${tenant.EmailAddress}</span>
                                                        </div>
                                                        <div class="d-flex flex-column border-0 ">
                                                            <span>Tenant since</span>
                                                            <span class="fw-bold" id="tenantAddedDate">${formattedAddedDate}</span>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2  border-0 align-items-center ">
                                                        <i class="fa fa-user" aria-hidden="true"></i>
                                                        <span>Account Status</span>
                                                        <i class="fa fa-check-circle"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        @if(addTenantPermission){
                                            <div class="right-side-header" style="padding-top:18px!important;padding-right: 27px!important;">
                                                <button class="btn btn-success" style="background-color: #c9c9c9;color: white;" type="button" type="button" onclick="editTenant(${tenant.TenantId})">
                                                    Edit Tenant
                                                </button>
                                                <button class="btn btn-danger" style="background-color: #c9c9c9;color: white;" type="button" type="button" onclick="deleteTenant(${tenant.TenantId})">
                                                    Delete Tenant
                                                </button>
                                            </div>
                                        }
                                        
                                    </div>
                                </div>
                                <div class="row w-100 px-2">
                                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 px-md-4 px-2 py-3">
                                        <div class="text-primary fw-bold">Current Assets</div>
                                        ${tenant.Assets.length > 0 ? `
                                            <table class="table mt-3">
                                                <thead>
                                                    <tr>
                                                        <th>Property</th>
                                                        <th>Address</th>
                                                        <th>Units</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${tenant.Assets.map(asset => `
                                                        <tr>
                                                            <td>${asset.BuildingNo} ${asset.BuildingName}</td>
                                                            <td>${asset.Street1} ${asset.Street2} ${asset.City} ${asset.Country}</td>
                                                            <td>${asset.Units.length > 0 ? asset.Units.map(unit => unit.UnitName).join(', ') : '-'}</td>

                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : '<div>No assets found for this tenant.</div>'}
                                    </div>
                                </div>
                                <div class="row w-100 px-2">
                                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 px-md-4 px-2 py-3">
                                        <div class="text-primary fw-bold">Current Leases</div>
                                        ${tenant.Leases.length > 0 ? `
                                            <table class="table mt-3">
                                                <thead>
                                                    <tr>
                                                        <th>Property</th>
                                                        <th>Units</th>
                                                        <th>Rent</th>
                                                        <th>Security Deposit</th>
                                                        <th>Late Fee Charges</th>
                                                        <th>Start Date</th>
                                                        <th>End Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${tenant.Leases.map(lease => `
                                                        <tr>
                                                            <td>${lease.SelectedProperty}</td>
                                                            <td>${lease.SelectedUnit}</td>
                                                            <td>${lease.RentCharges && lease.RentCharges.length > 0 ? sumAmounts(lease.RentCharges) : '-'}</td>
                                                            <td>${lease.SecurityDeposits && lease.SecurityDeposits.length > 0 ? sumAmounts(lease.SecurityDeposits) : '-'}</td>
                                                            <td>${lease.FeeCharges && lease.FeeCharges.length > 0 ? sumAmounts(lease.FeeCharges) : '-'}</td>
                                                            <td>${new Date(lease.StartDate).toLocaleDateString()}</td>
                                                            <td>${new Date(lease.EndDate).toLocaleDateString()}</td>

                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : '<div>No leases found for this tenant.</div>'}
                                    </div>
                                </div>
                                <div class="row w-100 px-2">
                                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 px-md-4 px-2 py-3">
                                        <div class="text-primary fw-bold">Current Invoices</div>
                                        ${tenant.Invoices.length > 0 ? `
                                                    <table id="invoicesTable"  class="table mt-3">
                                                <thead>
                                                    <tr>
                                                        <th>Tenant</th>
                                                        <th>Rent Amount</th>
                                                        <th>Paid</th>
                                                        <th>Paid to Owner</th>
                                                        <th>Created Date</th>
                                                        <th>Expiration Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${tenant.Invoices.map(invoice => `
                                                        <tr>
                                                            <td>${invoice.TenantName}</td>
                                                            <td>${invoice.RentAmount}</td>
                                                            <td>${invoice.InvoicePaid ? 'Yes' : 'No'}</td>
                                                            <td>${invoice.InvoicePaidToOwner ? 'Yes' : 'No'}</td>
                                                            <td>${new Date(invoice.InvoiceCreatedDate).toLocaleDateString()}</td>
                                                            <td>${new Date(invoice.InvoiceDate).toLocaleDateString()}</td>

                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : '<div>No leases found for this tenant.</div>'}
                                    </div>
                                </div>
                            </div>
                        `;
                $('#tenantDetailDiv').empty().append(tenantssHtml);
                $('#invoicesTable').DataTable();
                hideLoader();
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('Failed to retrieve data');
                hideLoader();
            }
        });
    }

    // Function to show the loader
    function showLoader() {
        var opts = {
            lines: 13,
            length: 20, // Adjusted length
        width: 10,  // Adjusted width
        radius: 30,
            scale: 1,
            corners: 1,
            color: '#000',
            fadeColor: 'transparent',
            speed: 1,
            rotate: 0,
            animation: 'spinner-line-fade-quick',
            direction: 1,
            zIndex: 2e9,
            className: 'spinner',
            top: '50%',
            left: '50%',
            shadow: '0 0 1px transparent',
            position: 'absolute'
        };
        var target = document.getElementById('loader');
        var spinner = new Spinner(opts).spin(target);
        $('#loader').show();
    }

    function hideLoader() {
        $('#loader').hide();
        $('.spinner').remove();
    }

    function editTenant(tenantId) {
        window.location.href = `/Tenant/EditTenant?tenantId=${tenantId}`;
    }

    function deleteTenant(tenantId) {
        Swal.fire({
            title: 'Are you sure?',
            text: 'Once deleted, you will not be able to recover this tenant!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/Tenant/Delete/?tenantId=${encodeURIComponent(tenantId)}`,
                    type: 'POST',
                    success: function (res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Tenant deleted successfully',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            location.reload()
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: res.message,
                                text: 'Something went wrong!'
                            });
                        }

                    },
                    error: function () {
                        Swal.fire(
                            'Error!',
                            'There was an issue deleting the tenant.',
                            'error'
                        );
                    }
                });
            }
        });
    }
</script>